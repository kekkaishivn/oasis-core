# Benchmark analysis

This tool compares benchmark results generated by `oasis-test-runner` and
corresponding `oasis-node` workers.

## Requirements

`ba` connects to the Prometheus server which collected metrics during
`oasis-test-runner` test runs. By default `ba` assumes the server is running on
`http://localhost:9090`.

## Usage

Currently, `cmp` operation is implemented which compares the benchmark results
of the last (`source`) and pre-last (`target`) test batch (also called
*instance*):
```bash
$ ba/ba cmp
```

You can provide custom Prometheus address by `--metrics.address` flag:
```bash
$ ba/ba cmp \
  --metrics.address http://prometheus.myorg.com:9090
```

By default `cmp` command will fetch the results of all `oasis-test-runner`
tests and metrics. If you want to compare specific metric(s) and test(s),
provide `--metrics` and `--test` flags respectively:
```bash
$ ba/ba cmp \
  --metrics time \
  --test multiple-runtimes
```

`ba` takes *thresholds* for each metric into account. Currently, `avg_ratio`
and `max_ratio` are supported which correspond to the average and maximum ratio
of metric values of all test runs in the benchmark batch. For each ratio, you
can set the `max_threshold` and `min_threshold`. The former requires that the
ratio should not be exceeded and the latter that the provided threshold must be
reached. If not, `ba` will exit with error code. This is useful for integration
into CI pipelines. Thresholds can be using the flag
`--{min|max}_threshold.<metric name>.{avg|max}_ratio`.

For example:
```bash
$ ba/ba cmp \
  --metrics time \
  --test multiple-runtimes \
  --max_threshold.time.avg_ratio 1.1
```

will require that the average duration of the test in the last benchmark batch
should be at most 10\% slower than from the pre-last benchmark batch.

If you are developing or improving a feature in a separate git branch, you will
want to perform benchmarks and compare the results of your branch to the ones
from the master branch. `oasis-test-runner` already sends information of the
git branch it is compiled on to Prometheus, so all you need to do is perform
benchmarks on both master and feature branches using the same Prometheus
instance. Then, `ba` will compare the last benchmark batch from the provided
source git branch to the last batch from the target git branch:
```bash
$ ba/ba cmp \
  --metrics.source.git_branch=feature_branch \
  --metrics.target.git_branch=master
```

For detailed help, run:
```bash
$ ba/ba cmp --help
```