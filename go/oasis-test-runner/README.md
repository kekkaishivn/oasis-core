# Oasis test runner

`oasis-test-runner` initializes and executes end-to-end and remote signer test
suites.

To list all supported tests and corresponding parameters, type:
```bash
$ oasis-test-runner list
```

By default, all supported tests are executed.

## Benchmarking

To benchmark tests, set the `--metrics.address` parameter to the address of the
Prometheus push gateway along with `--metrics.push.interval`. Additionally, you
can set the number of runs each test should be run with `--num_runs` parameter.

## Benchmark analysis with `oasis-test-runner cmp` command 

This command compares benchmark results generated by `oasis-test-runner` and
corresponding `oasis-node` workers.

### Requirements

`oasis-test-runner cmp` connects to the Prometheus server which collected metrics during
`oasis-test-runner` test runs. By default it assumes the server is running on
`http://localhost:9090`.

### Usage

`cmp` command compares the benchmark results of the last (`source`) and
pre-last (`target`) test batch (also called *instance*):
```bash
$ oasis-test-runner cmp
```

You can provide custom Prometheus address by `--metrics.address` flag:
```bash
$ oasis-test-runner cmp \
  --metrics.address http://prometheus.myorg.com:9090
```

By default `cmp` command will fetch the results of all `oasis-test-runner`
tests and metrics. If you want to compare specific metric(s) and test(s),
provide `--metrics` and `--test` flags respectively:
```bash
$ oasis-test-runner cmp \
  --metrics time \
  --test multiple-runtimes
```

`cmp` takes *thresholds* for each metric into account. Currently, `avg_ratio`
and `max_ratio` are supported which correspond to the average and maximum ratio
of metric values of all test runs in the benchmark batch. For each ratio, you
can set the `max_threshold` and `min_threshold`. The former requires that the
ratio should not be exceeded and the latter that the provided threshold must be
reached. If not, `oasis-test-runner cmp` will exit with error code. This is
useful for integration into CI pipelines. Thresholds can be using the flag
`--{min|max}_threshold.<metric name>.{avg|max}_ratio`.

For example:
```bash
$ oasis-test-runner cmp \
  --metrics time \
  --test multiple-runtimes \
  --max_threshold.time.avg_ratio 1.1
```

will require that the average duration of the test in the last benchmark batch
should be at most 10\% slower than from the pre-last benchmark batch.

If you are developing or improving a feature in a separate git branch, you will
want to perform benchmarks and compare the results of your branch to the ones
from the master branch. `oasis-test-runner` already sends information of the
git branch it is compiled on to Prometheus, so all you need to do is perform
benchmarks on both master and feature branches using the same Prometheus
instance. Then, `cmp` will compare the last benchmark batch from the provided
source git branch to the last batch from the target git branch:
```bash
$ oasis-test-runner cmp \
  --metrics.source.git_branch=feature_branch \
  --metrics.target.git_branch=master
```

For detailed help, run:
```bash
$ oasis-test-runner cmp --help
```